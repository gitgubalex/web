<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate Validator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <style>
      @keyframes fade-in {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .animate-spin { animation: spin 1s linear infinite; }
    </style>
    <link rel="stylesheet" href="/index.css">
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
    // ============================================================================
    // UTILS
    // ============================================================================
    const ValidationStatus = { IDLE: 'idle', SUCCESS: 'success', NOT_FOUND: 'not_found', ERROR: 'error' };

    const getProperty = (obj, keyName) => {
      if (!obj || typeof obj !== 'object' || !keyName) return undefined;
      const keyToFind = keyName.toLowerCase();
      const foundKey = Object.keys(obj).find(k => k.trim().toLowerCase() === keyToFind);
      return foundKey ? obj[foundKey] : undefined;
    };

    const getFlexibleProperty = (obj, keys) => {
      if (!obj || typeof obj !== 'object' || !Array.isArray(keys)) return undefined;
      for (const key of keys) {
        const value = getProperty(obj, key);
        if (value !== undefined && value !== null) return value;
      }
      return undefined;
    };

    const formatDate = (dateValue) => {
      if (dateValue === undefined || dateValue === null) return 'N/A';
      if (typeof dateValue === 'string') return dateValue;
      let date;
      if (typeof dateValue === 'number') {
        date = new Date((dateValue - 25569) * 86400 * 1000);
        date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
      } else {
        date = new Date(dateValue);
      }
      if (!date || isNaN(date.getTime())) return String(dateValue);
      return date.toLocaleDateString('es-ES',{ day: '2-digit', month: 'long', year: 'numeric', timeZone: 'UTC' });
    };

    // ============================================================================
    // DEBUGGER SOLO ADMIN
    // ============================================================================
    const DebugInfo = ({ debugData }) => {
      if (!debugData || debugData.length === 0) return null;
      return (
        <div className="mt-8 p-4 bg-slate-100 border border-slate-300 rounded-lg shadow-inner animate-fade-in">
          <h3 className="text-lg font-bold mb-2 text-blue-600">ðŸ“Š Debugger de Hojas Cargadas</h3>
          <table className="w-full text-sm text-left border-collapse">
            <thead>
              <tr className="bg-slate-200 text-slate-800">
                <th className="border px-3 py-2">Hoja</th>
                <th className="border px-3 py-2">Estatus</th>
                <th className="border px-3 py-2">Registros</th>
                <th className="border px-3 py-2">Folio Ejemplo</th>
              </tr>
            </thead>
            <tbody>
              {debugData.map((info, idx) => (
                <tr key={idx} className="odd:bg-white even:bg-slate-50">
                  <td className="border px-3 py-2 font-semibold">{info.sheetName}</td>
                  <td className="border px-3 py-2">{info.status}</td>
                  <td className="border px-3 py-2 text-center">{info.jsonDataPreview ? info.jsonDataPreview.length : 0}</td>
                  <td className="border px-3 py-2">
                    {info.jsonDataPreview && info.jsonDataPreview[0]
                      ? (getFlexibleProperty(info.jsonDataPreview[0], ['Folio','ID','Clave','Constancia','Folio de Constancia']) || 'N/A')
                      : 'N/A'}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // ============================================================================
    // PASSWORD PROMPT
    // ============================================================================
    const PasswordPrompt = ({ onConfirm, onCancel }) => {
      const { useState, useEffect, useRef } = React;
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const inputRef = useRef(null);
      const correctPassword = "Tecno2021$";
      useEffect(() => { inputRef.current?.focus(); }, []);
      const handleSubmit = (e) => {
        e.preventDefault();
        if (password === correctPassword) onConfirm();
        else { setError('Clave incorrecta. Intente de nuevo.'); setPassword(''); }
      };
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
          <div className="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4">
            <h3 className="text-lg font-bold text-slate-800">Acceso Restringido</h3>
            <p className="text-sm text-slate-600 mt-1 mb-4">Ingrese la clave para cargar un nuevo archivo.</p>
            <form onSubmit={handleSubmit}>
              <input ref={inputRef} type="password" value={password}
                onChange={(e) => { setPassword(e.target.value); setError(''); }}
                className={`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none sm:text-sm ${error ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-slate-300 focus:ring-blue-500 focus:border-blue-500'}`}
                placeholder="Clave de administrador"/>
              {error && <p className="text-red-600 text-xs mt-2">{error}</p>}
              <div className="mt-4 flex justify-end space-x-2">
                <button type="button" onClick={onCancel}
                  className="px-4 py-2 text-sm font-semibold text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200">
                  Cancelar
                </button>
                <button type="submit"
                  className="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                  Confirmar
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // ============================================================================
    // SEARCH BAR
    // ============================================================================
    const SearchBar = ({ query, setQuery, onSearch, onClear }) => {
      return (
        <form
          className="flex items-center space-x-2 max-w-xl mx-auto mb-8"
          onSubmit={e => { e.preventDefault(); onSearch(query); }}
        >
          <input
            type="text"
            className="flex-grow px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="Ingrese el folio o clave de constancia..."
            value={query}
            onChange={e => setQuery(e.target.value)}
            autoFocus
          />
          <button
            type="submit"
            className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition"
          >
            Buscar
          </button>
          <button
            type="button"
            className="px-3 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition"
            onClick={onClear}
          >
            Limpiar
          </button>
        </form>
      );
    };

    // ============================================================================
    // VALIDATION RESULT
    // ============================================================================
    const ValidationResult = ({ status, result }) => {
      if (status === ValidationStatus.IDLE) return null;
      if (status === ValidationStatus.NOT_FOUND)
        return (
          <div className="max-w-xl mx-auto mt-4 p-4 bg-red-100 border border-red-300 rounded-lg animate-fade-in">
            <p className="text-red-800 font-semibold">No se encontrÃ³ ninguna constancia con ese folio o clave.</p>
          </div>
        );
      if (status === ValidationStatus.ERROR)
        return (
          <div className="max-w-xl mx-auto mt-4 p-4 bg-yellow-100 border border-yellow-300 rounded-lg animate-fade-in">
            <p className="text-yellow-800 font-semibold">OcurriÃ³ un error al validar la constancia.</p>
          </div>
        );
      if (status === ValidationStatus.SUCCESS && result) {
        return (
          <div className="max-w-xl mx-auto mt-6 p-6 bg-green-100 border border-green-300 rounded-lg animate-fade-in">
            <h2 className="text-xl font-bold text-green-700 mb-2">âœ… Constancia encontrada</h2>
            <table className="w-full text-sm text-left border-collapse">
              <tbody>
                {Object.entries(result).map(([key, value], idx) => (
                  <tr key={idx} className="odd:bg-white even:bg-green-50">
                    <td className="font-semibold py-2 px-3 border">{key}</td>
                    <td className="py-2 px-3 border">{formatDate(value)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }
      return null;
    };

    // ============================================================================
    // MAIN APP
    // ============================================================================
    const App = () => {
      const { useState, useEffect } = React;
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [certificateData, setCertificateData] = useState([]);
      const [debugInfo, setDebugInfo] = useState(null);
      const [databaseLoaded, setDatabaseLoaded] = useState(false);
      const [query, setQuery] = useState('');
      const [validationStatus, setValidationStatus] = useState(ValidationStatus.IDLE);
      const [validationResult, setValidationResult] = useState(null);
      const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false); // âœ… estado de administrador

      const potentialFolioHeaders = [
        'folio','id','clave','constancia','folio de constancia',
        'folio constancia','no. folio','nÃºmero de folio','num folio','folio certificado'
      ];

      const handleFileProcessed = (arrayBuffer) => {
        try {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          let allData = [];
          const allDebugInfo = [];

          workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            if (!worksheet || !worksheet['!ref']) { allDebugInfo.push({ sheetName, status:'Skipped (empty)' }); return; }
            const dataAoA = XLSX.utils.sheet_to_json(worksheet, { header:1, blankrows:false });
            if (dataAoA.length === 0) { allDebugInfo.push({ sheetName, status:'Skipped (no data)' }); return; }

            let headerRowIndex = -1;
            for (let i=0; i<dataAoA.length; i++) {
              const row = dataAoA[i];
              if (Array.isArray(row) && row.some(cell => {
                const cellVal = String(cell || '').trim().toLowerCase();
                return potentialFolioHeaders.includes(cellVal);
              })) { headerRowIndex = i; break; }
            }

            if (headerRowIndex === -1) { allDebugInfo.push({ sheetName, status:'Skipped (no header)', dataPreview:dataAoA.slice(0,5)}); return; }

            const headers = dataAoA[headerRowIndex].map(h => (h ? String(h).trim() : ''));
            const dataRows = dataAoA.slice(headerRowIndex+1);

            const sheetJson = dataRows
              .filter(row => Array.isArray(row) && row.some(cell => String(cell||'').trim() !== ''))
              .map(row => {
                const record = {};
                headers.forEach((header, i) => { if (header && i < row.length) record[header] = row[i]; });
                return record;
              });

            allDebugInfo.push({ sheetName, status:`Processed ${sheetJson.length} records.`, jsonDataPreview:sheetJson.slice(0,3) });
            allData = allData.concat(sheetJson);
          });

          setCertificateData(allData);
          setDebugInfo(allDebugInfo);
          setDatabaseLoaded(true);
        } catch (e) {
          setError('No se pudo procesar el archivo Excel.');
          setDatabaseLoaded(false);
        } finally { setLoading(false); }
      };

      useEffect(() => {
        const loadDatabase = async () => {
          setError(null);
          try {
            // CAMBIO IMPORTANTE: Usa la URL absoluta para funcionar bien en GitHub Pages
            const response = await fetch('https://gitgubalex.github.io/web/database.xlsx');
            if (!response.ok) { setLoading(false); return; }
            const arrayBuffer = await response.arrayBuffer();
            handleFileProcessed(arrayBuffer);
          } catch { setLoading(false); }
        };
        loadDatabase();
      }, []);

      const handleSearch = (searchQuery) => {
        if (!searchQuery || certificateData.length === 0) { setValidationStatus(ValidationStatus.IDLE); setValidationResult(null); return; }
        const cleanedQuery = searchQuery.trim().toLowerCase();
        const result = certificateData.find(record => {
          const folioValue = getFlexibleProperty(record, potentialFolioHeaders);
          return folioValue && String(folioValue).trim().toLowerCase() === cleanedQuery;
        });
        if (result) { setValidationResult(result); setValidationStatus(ValidationStatus.SUCCESS); }
        else { setValidationResult(null); setValidationStatus(ValidationStatus.NOT_FOUND); }
      };

      const handleClear = () => { setQuery(''); setValidationStatus(ValidationStatus.IDLE); setValidationResult(null); };

      const performReset = () => {
        setDatabaseLoaded(false); setCertificateData([]); setDebugInfo(null);
        setError(null); handleClear(); setShowPasswordPrompt(false);
        setIsAdmin(true); // âœ… activa modo admin
      };

      const handleResetRequest = () => setShowPasswordPrompt(true);

      const renderContent = () => {
        if (loading) return <p>Cargando base de datos...</p>;
        if (databaseLoaded) {
          return (
            <div className="animate-fade-in">
              <SearchBar
                query={query}
                setQuery={setQuery}
                onSearch={handleSearch}
                onClear={handleClear}
              />
              <ValidationResult status={validationStatus} result={validationResult} />
              {isAdmin && <DebugInfo debugData={debugInfo} />}
              <div className="mt-6 text-center">
                <button onClick={handleResetRequest} className="text-sm font-semibold text-blue-600 hover:text-blue-800">
                  Cargar otro archivo
                </button>
              </div>
            </div>
          );
        }
        return <p>No se encontrÃ³ database.xlsx. Cargue manualmente.</p>;
      };

      return (
        <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex flex-col">
          {showPasswordPrompt && <PasswordPrompt onConfirm={performReset} onCancel={() => setShowPasswordPrompt(false)} />}
          <header className="bg-white shadow-sm sticky top-0 z-10 p-4">
            <h1 className="text-lg font-bold">Validador de Constancias ITD</h1>
          </header>
          <main className="flex-grow container mx-auto p-6">{renderContent()}</main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  </body>
</html>