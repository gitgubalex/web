<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validador de Constancias y Reconocimientos del ITD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        background-color: #f0f4f8;
      }
      @keyframes fade-in {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .animate-spin { animation: spin 1s linear infinite; }
    </style>
    <link rel="stylesheet" href="/index.css">
  </head>
  <body>
    <div id="root"></div>
    <audio id="beep-success" src="https://cdn.jsdelivr.net/gh/gitbubs/my-apps-3/success.mp3" preload="auto"></audio>
    <audio id="beep-fail" src="https://cdn.jsdelivr.net/gh/gitbubs/my-apps-3/fail.mp3" preload="auto"></audio>
    <script type="text/babel">
    // ============================================================================
    // CONFIG & UTILS
    // ============================================================================
    
    // <-- ¡IMPORTANTE! Reemplace con la URL real de su logo.
    const LOGO_URL = 'https://gitgubalex.github.io/web/image.jpg'; 

    const ValidationStatus = { IDLE: 'idle', SUCCESS: 'success', NOT_FOUND: 'not_found', ERROR: 'error' };

    const getProperty = (obj, keyName) => {
      if (!obj || typeof obj !== 'object' || !keyName) return undefined;
      const keyToFind = keyName.toLowerCase();
      const foundKey = Object.keys(obj).find(k => k.trim().toLowerCase() === keyToFind);
      return foundKey ? obj[foundKey] : undefined;
    };

    const getFlexibleProperty = (obj, keys) => {
      if (!obj || typeof obj !== 'object' || !Array.isArray(keys)) return undefined;
      for (const key of keys) {
        const value = getProperty(obj, key);
        if (value !== undefined && value !== null) return value;
      }
      return undefined;
    };

    const formatDate = (dateValue) => {
        if (dateValue === undefined || dateValue === null) return 'N/A';
        if (typeof dateValue === 'string') {
             if (!isNaN(dateValue) && !isNaN(parseFloat(dateValue))) {
                 let date = new Date((parseFloat(dateValue) - 25569) * 86400 * 1000);
                 date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
                 if (isNaN(date.getTime())) return String(dateValue);
                 return date.toLocaleDateString('es-ES',{ day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }).toUpperCase();
             }
             return dateValue.toUpperCase();
        }
        let date;
        if (typeof dateValue === 'number') {
            date = new Date((dateValue - 25569) * 86400 * 1000);
            date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
        } else {
            date = new Date(dateValue);
        }
        if (!date || isNaN(date.getTime())) return String(dateValue).toUpperCase();
        return date.toLocaleDateString('es-ES',{ day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }).toUpperCase();
    };

    const playSound = (id) => {
        const sound = document.getElementById(id);
        if (sound) {
            sound.currentTime = 0;
            sound.play().catch(error => console.error(`Error playing sound: ${id}`, error));
        }
    };
    
    // ============================================================================
    // PDF Generation
    // ============================================================================
    const getImageDataFromURL = (url) => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL('image/jpeg');
          resolve({ dataURL, width: img.width, height: img.height });
        };
        img.onerror = reject;
        img.src = url;
      });
    };

    const generatePdf = async (result) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        try {
            const { dataURL, width, height } = await getImageDataFromURL(LOGO_URL);
            const aspectRatio = width / height;
            
            // Se establece una altura fija y se calcula el ancho para mantener la proporción, evitando distorsión.
            const pdfImageHeight = 25;
            const pdfImageWidth = pdfImageHeight * aspectRatio;

            doc.addImage(dataURL, 'JPEG', 15, 12, pdfImageWidth, pdfImageHeight);
        } catch (error) {
            console.error("No se pudo agregar el logo al PDF:", error);
        }

        // Header
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("TECNOLÓGICO NACIONAL DE MÉXICO", 105, 20, { align: 'center' });
        doc.text("INSTITUTO TECNOLÓGICO DE DURANGO", 105, 27, { align: 'center' });

        // Title
        doc.setFontSize(18);
        doc.text("Constancia de Validez", 105, 45, { align: 'center' });
        
        const data = {
            'Folio': getFlexibleProperty(result, ['Folio', 'ID']),
            'Nombre del Titular': getFlexibleProperty(result, ['Nombre', 'Nombre del Titular']),
            'Curso/Taller': getFlexibleProperty(result, ['Curso', 'Nombre del curso-taller']),
            'Fecha': getFlexibleProperty(result, ['Fecha', 'Fecha del curso-taller']),
            'Departamento': getFlexibleProperty(result, ['Departamento']),
            'Duración': getFlexibleProperty(result, ['Duracion', 'Duración']),
        };
        
        let y = 65;
        doc.setFontSize(11);
        const labelX = 20;
        const valueX = 70;

        const getDisplayValue = (key, value) => {
          if (value === null || value === undefined) return 'N/A';
          let valueStr = String(value).trim();
          if (key === 'Fecha') return formatDate(value);
          if (key === 'Duración') {
             if (!isNaN(valueStr) && valueStr !== '') return `${valueStr} HORAS`;
             return valueStr.toUpperCase();
          }
          return valueStr.toUpperCase();
        };

        Object.entries(data).forEach(([key, value]) => {
            doc.setFont("helvetica", "bold");
            doc.text(`${key}:`, labelX, y);
            doc.setFont("helvetica", "normal");
            const displayValue = getDisplayValue(key, value);
            const lines = doc.splitTextToSize(displayValue, 120);
            doc.text(lines, valueX, y);
            y += (lines.length * 7) + 5;
        });

        y += 5;

        // Footer
        doc.setLineWidth(0.2);
        doc.line(20, y, 190, y);
        y += 10;
        doc.setFontSize(9);
        doc.setTextColor(150, 150, 150);
        doc.setFont("helvetica", "normal");
        doc.text("Este documento es una representación digital para la verificación de la constancia.", 105, y, { align: 'center' });
        y += 5;
        const now = new Date();
        const generatedDate = now.toLocaleDateString('es-ES', { day: 'numeric', month: 'numeric', year: 'numeric' });
        const generatedTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        doc.text(`Generado el: ${generatedDate}, ${generatedTime}`, 105, y, { align: 'center' });
        y += 5;
        doc.text("Contacto para dudas o aclaraciones: coord_actualizaciondocente@itdurango.edu.mx", 105, y, { align: 'center' });

        doc.save(`Constancia-Validez-${getFlexibleProperty(result, ['Folio', 'ID']) || 'Certificado'}.pdf`);
    };

    // ============================================================================
    // COMPONENTS
    // ============================================================================
    const Header = () => (
      <header className="bg-white shadow-sm w-full">
        <div className="container mx-auto px-6 py-4 flex items-center">
          <img src={LOGO_URL} alt="Logo ITD" className="h-10 mr-4"/>
          <h1 className="text-xl font-bold text-gray-800">Validador de Constancias y Reconocimientos del ITD</h1>
        </div>
      </header>
    );

    const Footer = () => (
      <footer className="w-full mt-auto py-6 text-center text-xs text-gray-500">
        <p>© 2025 Validador de Constancias. Todos los derechos reservados.</p>
        <p>Desarrollo académico, coordinación de actualización docente del ITD.</p>
      </footer>
    );
    
    const SearchForm = ({ query, setQuery, onSearch, onClear }) => {
      const handleSearch = (e) => {
        e.preventDefault();
        onSearch(query);
      };

      return (
        <div className="bg-white p-8 rounded-xl shadow-md w-full max-w-2xl mx-auto">
          <h2 className="text-xl font-bold text-gray-800 mb-2">Buscar Constancia</h2>
          <p className="text-gray-600 mb-6">Ingrese el folio de la constancia para verificar su validez.</p>
          <form onSubmit={handleSearch} className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <div className="relative flex-grow w-full">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              <input
                type="text"
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Ej: TNM-054-00-2025-123"
                value={query}
                onChange={e => setQuery(e.target.value)}
                autoFocus
              />
            </div>
            <div className="flex space-x-2 w-full sm:w-auto">
              <button type="submit" className="flex-1 sm:flex-none px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200">
                Verificar
              </button>
              <button type="button" onClick={onClear} className="flex-1 sm:flex-none px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 transition duration-200">
                Borrar
              </button>
            </div>
          </form>
        </div>
      );
    };

    const ValidationResult = ({ status, result }) => {
      const { useState } = React;
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

      const handleDownload = async () => {
        if (!result) return;
        setIsGeneratingPdf(true);
        try {
          await generatePdf(result);
        } catch (error) {
          console.error("PDF Generation failed", error);
          alert("Hubo un error al generar el PDF.");
        } finally {
          setIsGeneratingPdf(false);
        }
      };

      if (status === ValidationStatus.IDLE) return null;

      if (status === ValidationStatus.NOT_FOUND) {
        return (
          <div className="w-full max-w-2xl mx-auto mt-8 p-6 bg-red-50 border-l-4 border-red-500 animate-fade-in rounded-r-lg">
            <div className="flex items-center">
              <svg className="w-8 h-8 text-red-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <div>
                <h3 className="text-lg font-bold text-red-800">Constancia no Encontrada</h3>
                <p className="text-red-700">El folio ingresado no fue encontrado en la base de datos. Por favor, verifique el folio e intente de nuevo.</p>
              </div>
            </div>
          </div>
        );
      }
      
      if (status === ValidationStatus.SUCCESS && result) {
        const displayData = {
          'Folio': getFlexibleProperty(result, ['Folio', 'ID']),
          'Nombre del Titular': getFlexibleProperty(result, ['Nombre', 'Nombre del Titular']),
          'Nombre del curso-taller': getFlexibleProperty(result, ['Curso', 'Nombre del curso-taller']),
          'Fecha del curso-taller': formatDate(getFlexibleProperty(result, ['Fecha', 'Fecha del curso-taller'])),
          'Departamento': getFlexibleProperty(result, ['Departamento']),
          'Duración': getFlexibleProperty(result, ['Duracion', 'Duración']),
        };

        return (
          <div className="w-full max-w-2xl mx-auto mt-8 bg-green-50 border-l-4 border-green-500 animate-fade-in rounded-r-lg">
            <div className="p-6">
                <div className="flex justify-between items-start">
                    <div className="flex items-center">
                        <svg className="w-8 h-8 text-green-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 className="text-lg font-bold text-green-800">Constancia Válida</h3>
                    </div>
                    <button 
                        onClick={handleDownload} 
                        disabled={isGeneratingPdf}
                        className="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200 disabled:bg-blue-400 disabled:cursor-not-allowed">
                        {isGeneratingPdf ? (
                            <>
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generando...
                            </>
                        ) : (
                            <>
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Descargar Validación
                            </>
                        )}
                    </button>
                </div>
            </div>
            <div className="bg-white p-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm rounded-b-lg">
              {Object.entries(displayData).map(([key, value]) => (
                <div key={key}>
                  <p className="text-gray-500">{key}</p>
                  <p className="font-bold text-gray-800">{value || 'N/A'}</p>
                </div>
              ))}
            </div>
          </div>
        );
      }

      return null;
    };
    
    // ============================================================================
    // MAIN APP
    // ============================================================================
    const App = () => {
      const { useState, useEffect } = React;
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [certificateData, setCertificateData] = useState([]);
      const [databaseLoaded, setDatabaseLoaded] = useState(false);
      const [query, setQuery] = useState('');
      const [validationStatus, setValidationStatus] = useState(ValidationStatus.IDLE);
      const [validationResult, setValidationResult] = useState(null);
      
      const potentialFolioHeaders = [
        'folio','id','clave','constancia','folio de constancia',
        'folio constancia','no. folio','número de folio','num folio','folio certificado'
      ];

      const handleFileProcessed = (arrayBuffer) => {
        try {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          let allData = [];

          workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            if (!worksheet || !worksheet['!ref']) return;
            const dataAoA = XLSX.utils.sheet_to_json(worksheet, { header:1, blankrows:false });
            if (dataAoA.length === 0) return;

            let headerRowIndex = -1;
            for (let i=0; i<dataAoA.length; i++) {
              const row = dataAoA[i];
              if (Array.isArray(row) && row.some(cell => {
                const cellVal = String(cell || '').trim().toLowerCase();
                return potentialFolioHeaders.includes(cellVal);
              })) { headerRowIndex = i; break; }
            }
            if (headerRowIndex === -1) return;

            const headers = dataAoA[headerRowIndex].map(h => (h ? String(h).trim() : ''));
            const dataRows = dataAoA.slice(headerRowIndex+1);

            const sheetJson = dataRows
              .filter(row => Array.isArray(row) && row.some(cell => String(cell||'').trim() !== ''))
              .map(row => {
                const record = {};
                headers.forEach((header, i) => { if (header && i < row.length) record[header] = row[i]; });
                return record;
              });

            allData = allData.concat(sheetJson);
          });

          setCertificateData(allData);
          setDatabaseLoaded(true);
        } catch (e) {
          setError('No se pudo procesar el archivo Excel.');
          setDatabaseLoaded(false);
        } finally { setLoading(false); }
      };

      useEffect(() => {
        const loadDatabase = async () => {
          setError(null);
          try {
            const response = await fetch('https://gitgubalex.github.io/web/database.xlsx');
            if (!response.ok) { setLoading(false); setError('No se pudo cargar la base de datos.'); return; }
            const arrayBuffer = await response.arrayBuffer();
            handleFileProcessed(arrayBuffer);
          } catch(e) { 
            console.error("Error loading database:", e);
            setLoading(false); 
            setError('Error de red al cargar la base de datos.');
          }
        };
        loadDatabase();
      }, []);

      const handleSearch = (searchQuery) => {
        if (!searchQuery || certificateData.length === 0) { 
          setValidationStatus(ValidationStatus.IDLE); 
          setValidationResult(null); 
          return; 
        }
        const cleanedQuery = searchQuery.trim().toLowerCase();
        const result = certificateData.find(record => {
          const folioValue = getFlexibleProperty(record, potentialFolioHeaders);
          return folioValue && String(folioValue).trim().toLowerCase() === cleanedQuery;
        });
        if (result) { 
            setValidationResult(result); 
            setValidationStatus(ValidationStatus.SUCCESS);
            playSound('beep-success');
        } else { 
            setValidationResult(null); 
            setValidationStatus(ValidationStatus.NOT_FOUND); 
            playSound('beep-fail');
            setTimeout(() => playSound('beep-fail'), 300);
        }
      };

      const handleClear = () => { setQuery(''); setValidationStatus(ValidationStatus.IDLE); setValidationResult(null); };

      const renderContent = () => {
        if (loading) return <div className="text-center"><p>Cargando base de datos...</p></div>;
        if (error) return <div className="text-center text-red-600"><p>{error}</p></div>;
        if (databaseLoaded) {
          return (
            <>
              <SearchForm
                query={query}
                setQuery={setQuery}
                onSearch={handleSearch}
                onClear={handleClear}
              />
              <ValidationResult status={validationStatus} result={validationResult} />
            </>
          );
        }
        return <div className="text-center"><p>No se encontró la base de datos.</p></div>;
      };

      return (
        <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex flex-col items-center">
          <Header />
          <main className="flex-grow container mx-auto p-6 w-full flex flex-col items-center">
            {renderContent()}
          </main>
          <Footer />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>