<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validador de Constancias y Reconocimientos ITD</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"/>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
</head>
<body class="bg-slate-100">
  <div id="root"></div>
  <script type="text/babel">

    // --------------------- ICONOS ---------------------
    // Puedes reemplazar estos componentes por tus SVGs favoritos
    const SearchIcon = (props) => (
      <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
          d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
      </svg>
    );
    const LogoIcon = (props) => (
      <svg {...props} fill="none" viewBox="0 0 32 32" stroke="currentColor">
        <circle cx="16" cy="16" r="15" stroke="blue" strokeWidth="2" fill="#0ea5e9"/>
        <text x="50%" y="55%" textAnchor="middle" fill="white" fontSize="12" fontFamily="Arial" dy=".3em">ITD</text>
      </svg>
    );

    // --------------------- ENUMS Y ESTADOS ---------------------
    const ValidationStatus = {
      IDLE: 'IDLE',
      FOUND: 'FOUND',
      NOT_FOUND: 'NOT_FOUND',
      ERROR: 'ERROR'
    };

    // --------------------- COMPONENTES ---------------------
    const SearchBar = ({ onSearch, onClear, query, setQuery, loading }) => {
      const handleInputChange = (e) => {
        setQuery(e.target.value);
      };
      const handleSubmit = (e) => {
        e.preventDefault();
        if (query) onSearch(query);
      };
      const handleClearClick = () => {
        onClear();
      };

      return (
        <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
          <h2 className="text-xl font-semibold text-slate-800 mb-1">Buscar Constancia o Reconocimiento</h2>
          <p className="text-slate-600 mb-4">Ingrese el folio de la constancia o reconocimiento para verificar su validez.</p>
          <form onSubmit={handleSubmit}>
            <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
              <div className="relative flex-grow">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <SearchIcon className="h-5 w-5 text-slate-400" />
                </div>
                <input
                  type="text"
                  value={query}
                  onChange={handleInputChange}
                  placeholder="Ej: TNM-054-00-2025-123"
                  className="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-md leading-5 bg-white placeholder-slate-400 focus:outline-none focus:placeholder-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-all"
                  aria-label="Folio de la constancia o reconocimiento"
                  disabled={loading}
                />
              </div>
              <button
                type="submit"
                className="px-6 py-3 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed"
                disabled={!query || loading}
              >
                {loading ? "Buscando..." : "Verificar"}
              </button>
              <button
                type="button"
                onClick={handleClearClick}
                className="px-6 py-3 text-sm font-semibold text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                disabled={loading}
              >
                Limpiar
              </button>
            </div>
          </form>
        </div>
      );
    };

    const ResultItem = ({ data }) => (
      <div className="bg-white p-6 mt-6 rounded-xl shadow-lg border border-blue-200">
        <h3 className="text-lg font-bold text-blue-700 mb-2">Constancia encontrada</h3>
        <ul className="text-slate-700">
          {Object.entries(data).map(([key, value]) => (
            <li key={key} className="py-1"><span className="font-semibold">{key}:</span> {String(value)}</li>
          ))}
        </ul>
      </div>
    );

    // --------------------- APP PRINCIPAL ---------------------
    const App = () => {
      const [certificateData, setCertificateData] = React.useState([]);
      const [databaseLoaded, setDatabaseLoaded] = React.useState(false);
      const [databaseError, setDatabaseError] = React.useState(false);
      const [query, setQuery] = React.useState('');
      const [validationStatus, setValidationStatus] = React.useState(ValidationStatus.IDLE);
      const [validationResult, setValidationResult] = React.useState(null);
      const [loading, setLoading] = React.useState(false);

      // --- Carga automática del archivo database.xlsx ---
      const handleFileProcessed = (arrayBuffer) => {
        try {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });

          let allData = [];
          workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            if (!worksheet || !worksheet['!ref']) return;
            const dataAoA = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const headerRowIndex = dataAoA.findIndex(row => Array.isArray(row) && row.some(cell => typeof cell === 'string' && /folio|id|clave|constancia/i.test(cell)));
            if (headerRowIndex === -1) return;
            const headers = dataAoA[headerRowIndex].map(h => (typeof h === 'string' ? h.trim() : h));
            const dataRows = dataAoA.slice(headerRowIndex + 1);
            const sheetJson = dataRows
              .filter(row => Array.isArray(row) && row.some(cell => cell != null && String(cell).trim() !== ''))
              .map(row => {
                const record = {};
                headers.forEach((header, i) => {
                  if (header && i < row.length) {
                    record[header] = row[i];
                  }
                });
                return record;
              });
            allData = allData.concat(sheetJson);
          });

          setCertificateData(allData);
          setDatabaseLoaded(true);
          setDatabaseError(false);
        } catch (e) {
          setCertificateData([]);
          setDatabaseLoaded(false);
          setDatabaseError(true);
        }
      };

      React.useEffect(() => {
        const loadDatabase = async () => {
          try {
            setDatabaseLoaded(false);
            setDatabaseError(false);
            const response = await fetch('https://gitgubalex.github.io/web/database.xlsx');
            if (!response.ok) {
              setDatabaseLoaded(false);
              setDatabaseError(true);
              return;
            }
            const arrayBuffer = await response.arrayBuffer();
            handleFileProcessed(arrayBuffer);
          } catch (err) {
            setDatabaseLoaded(false);
            setDatabaseError(true);
          }
        };
        loadDatabase();
      }, []);

      // --- Buscador ---
      const handleSearch = (folio) => {
        setLoading(true);
        setValidationStatus(ValidationStatus.IDLE);
        setValidationResult(null);

        // Normalización para buscar por distintos nombres de columna
        const result = certificateData.find(
          record => {
            const keys = Object.keys(record);
            for(let k of keys) {
              if(/folio|id|clave|constancia/i.test(k)) {
                if(String(record[k]).trim().toLowerCase() === folio.trim().toLowerCase()) {
                  return true;
                }
              }
            }
            return false;
          }
        );
        if (result) {
          setValidationStatus(ValidationStatus.FOUND);
          setValidationResult(result);
        } else {
          setValidationStatus(ValidationStatus.NOT_FOUND);
          setValidationResult(null);
        }
        setLoading(false);
      };

      const handleClear = () => {
        setQuery('');
        setValidationStatus(ValidationStatus.IDLE);
        setValidationResult(null);
      };

      // --- Render principal ---
      function renderContent() {
        if (databaseError) {
          return (
            <div className="bg-red-100 border border-red-300 text-red-700 p-6 rounded-xl shadow-lg max-w-xl mx-auto my-8">
              <h2 className="text-xl font-bold mb-2">Error al cargar la base de datos</h2>
              <p>No se pudo cargar el archivo <b>database.xlsx</b>. Intente nuevamente más tarde.</p>
            </div>
          );
        }
        if (!databaseLoaded) {
          return (
            <div className="bg-blue-100 border border-blue-300 text-blue-700 p-6 rounded-xl shadow-lg max-w-xl mx-auto my-8">
              <h2 className="text-xl font-bold mb-2">Cargando base de datos...</h2>
              <p>Por favor espere unos segundos.</p>
            </div>
          );
        }
        return (
          <>
            <SearchBar
              onSearch={handleSearch}
              onClear={handleClear}
              query={query}
              setQuery={setQuery}
              loading={loading}
            />
            {validationStatus === ValidationStatus.FOUND && (
              <ResultItem data={validationResult} />
            )}
            {validationStatus === ValidationStatus.NOT_FOUND && (
              <div className="bg-yellow-100 border border-yellow-300 text-yellow-700 p-6 mt-6 rounded-xl shadow-lg max-w-xl mx-auto">
                <h3 className="text-lg font-bold mb-2">No se encontró la constancia</h3>
                <p>Revise que el folio esté bien escrito e intente nuevamente.</p>
              </div>
            )}
          </>
        );
      }

      return (
        <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex flex-col">
          <header className="bg-white shadow-sm sticky top-0 z-10">
            <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
              <div className="flex items-center space-x-3">
                <LogoIcon className="h-8 w-8 text-blue-600" />
                <h1 className="text-lg sm:text-2xl font-bold text-slate-900 tracking-tight">
                  Validador de Constancias y Reconocimientos del ITD
                </h1>
              </div>
            </div>
          </header>
          <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 flex items-center justify-center">
            <div className="w-full max-w-3xl mx-auto">
              {renderContent()}
            </div>
          </main>
          <footer className="py-6 text-center text-slate-500 text-sm">
            <p>&copy; {new Date().getFullYear()} Validador de Constancias. Todos los derechos reservados.</p>
            <p className="mt-2">Desarrollo académico, coordinación de actualización docente del ITD.</p>
          </footer>
        </div>
      );
    };

    // --------------------- RENDER APP ---------------------
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
  </script>
</body>
</html>